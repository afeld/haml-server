<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <title>haml-server</title>
  <link rel="stylesheet" href="http://jashkenas.github.com/docco/resources/docco.css">
</head>
<body>
<div id='container'>
  <div id="background"></div>
  <table cellspacing=0 cellpadding=0>
  <thead>
    <tr>
      <th class=docs><h1>haml-server</h1></th>
      <th class=code></th>
    </tr>
  </thead>
  <tbody>
    <tr id='section-1'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-1">&#182;</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-2'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-2">&#182;</a>
        </div>
        <p><strong>haml-server</strong> is a dead-simple Sinatra app for serving up a directory of
files. There are a few other projects much more ambitious than this (such as
<a href="https://github.com/bernerdschaefer/haml-server">serve</a>), but haml-server&rsquo;s goal is simple: serve haml files. Why? Because
writing <code>HTML</code> is a pain &mdash; especially when you&rsquo;re just putting together a
prototype, or, say, testing out some javascript behavior.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-Installation'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Installation">&#182;</a>
        </div>
        <h3>Installation</h3>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-4'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-4">&#182;</a>
        </div>
        <p>This is the easy part! Run this from your default ruby (or default RVM ruby)
so you have access to <code>haml-server</code> from wherever you are.</p>

<pre><code>gem install haml-server
</code></pre>

<p>You can also grab the code from <a href="https://github.com/bernerdschaefer/haml-server">github</a>.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-Usage'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Usage">&#182;</a>
        </div>
        <h3>Usage</h3>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-6'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-6">&#182;</a>
        </div>
        <p>Think of <code>haml-server</code> as <code>python -m SimpleHTTPServer</code>&hellip; but for <code>HAML</code>!</p>

<pre><code>haml-server # serves the current directory at localhost:4567
haml-server . # ^ same as above
haml-server -p 8000 sub/dir
</code></pre>

<p>Visiting <code>http://localhost:4567/</code> will render <code>index.haml</code>. Visiting
<code>/path/to/resource</code> will render <code>path/to/resource.haml</code>. Simple.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-Layouts'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Layouts">&#182;</a>
        </div>
        <h4>Layouts</h4>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-8'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-8">&#182;</a>
        </div>
        <p>You can also create a file called <code>layout.haml</code> to apply a layout to each of
your pages:</p>

<pre><code># layout.haml
%html
  %body
    = yield
</code></pre>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-SASS'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-SASS">&#182;</a>
        </div>
        <h4>SASS</h4>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-10'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-10">&#182;</a>
        </div>
        <p>If you want to use SASS templates, you can either define them inline using
HAML&rsquo;s filters, like so:</p>

<pre><code># index.haml
%html
  %head
    :sass
      .content
        width: 10px
</code></pre>

<p>Or you can write them to a standalone file, and then link to the same file
but with &ldquo;.css&rdquo; instead of &ldquo;.sass&rdquo;. So if you had <code>/stylesheets/screen.sass</code>,
then you might do this in your layout:</p>

<pre><code># layout.haml
%html
  %head
    :css
      @import url(/stylesheets/screen.css);
</code></pre>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-Helpers'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Helpers">&#182;</a>
        </div>
        <h4>Helpers</h4>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-12'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-12">&#182;</a>
        </div>
        <p>You can create a file called <code>helpers.rb</code> to define any helpers you might
want to make available.</p>

<pre><code># helpers.rb
require "pygmentize"

def highlight(code, format)
  Pygmentize.process(code, format)
end

alias hi highlight
</code></pre>

<p>And then in your views, you can access the helpers:</p>

<pre><code># index.haml

%h3 Example code
~ hi "puts '1 + 2 # =&gt; 3'", :ruby
</code></pre>

<p>The helpers are reloaded before each request, so you can add and remove them
without restarting the server.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-Running_on_Heroku_(cedar_stack)'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Running_on_Heroku_(cedar_stack)">&#182;</a>
        </div>
        <h3>Running on Heroku (cedar stack)</h3>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-14'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-14">&#182;</a>
        </div>
        <p>With Heroku&rsquo;s cedar stack, it&rsquo;s now super easy to deploy your <code>haml-server</code>
site for anyone to see. Here&rsquo;s a step-by-step walkthrough for deploying to
Heroku, with some recommendations for how to structe the site.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-Structure'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Structure">&#182;</a>
        </div>
        <h4>Structure</h4>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-16'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-16">&#182;</a>
        </div>
        <p>Since we&rsquo;ll be adding some additional files to get things wired up, I
recommend you move your views and static files into a separate folder like
<code>site</code> (the walkthrough will assume that you&rsquo;ve done so). So your site might
look like this:</p>

<pre><code>&gt; tree
.
├── helpers.rb
└── site
    ├── index.haml
    ├── layout.haml
    └── screen.css
</code></pre>

<p>When working locally, then, you&rsquo;ll want to run the site with: <code>haml-server
site</code>.</p>

<p>Now to get things set up for Heroku, we&rsquo;ll need to add a few files:</p>

<pre><code># Gemfile
source :rubygems
gem "haml-server"

# Procfile
web: bundle exec haml-server -p $PORT site
</code></pre>

<p>Now the project should look like this:</p>

<pre><code>&gt; tree
.
├── Gemfile
├── Procfile
├── helpers.rb
└── site
    ├── index.haml
    ├── layout.haml
    └── screen.css
</code></pre>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-Deploy'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Deploy">&#182;</a>
        </div>
        <h4>Deploy</h4>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-18'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-18">&#182;</a>
        </div>
        <p>First we&rsquo;ll need to get our environment in order by running:</p>

<pre><code>&gt; gem install bundler
&gt; bundle
</code></pre>

<p>This will install any dependencies, and store those in a file called
<code>Gemfile.lock</code>.</p>

<p>Now we should set up the site as a <code>git</code> repository, and commit our files.</p>

<pre><code>&gt; git init
&gt; git add .
&gt; git commit -m "Initial commit"
</code></pre>

<p>We&rsquo;re almost done! Now we&rsquo;ll create a new application and deploy it:</p>

<pre><code>&gt; gem install heroku
&gt; heroku apps:create --stack cedar
&gt; git push heroku master
&gt; heroku open
</code></pre>

<p><code>heroku open</code> will open up your site in the browser. Done!</p>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-The_code'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-The_code">&#182;</a>
        </div>
        <h3>The code</h3>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-20'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-20">&#182;</a>
        </div>
        <p><code>HAML</code>, check!</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="nb">require</span> <span class="s2">&quot;haml&quot;</span></pre></div>
      </td>
    </tr>
    <tr id='section-21'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-21">&#182;</a>
        </div>
        <p><code>SASS</code>, check!</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="nb">require</span> <span class="s2">&quot;sass&quot;</span></pre></div>
      </td>
    </tr>
    <tr id='section-22'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-22">&#182;</a>
        </div>
        <p>Okay. In any other context, this would be pretty evil. Let me explain.
Sinatra is a well-behaving citizen, and calls <code>ARGV.dup</code> before parsing its
options.  Unfortunately for us, that means if we want to easily add
additional arguments, we either have to 1) re-parse <code>ARGV</code> (which would mean
copying the options from <code>sinatra/main.rb</code>) or 2) just redefine <code>ARGV.dup</code>.
Should be clear which one I prefer.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="k">def</span> <span class="nc">ARGV</span><span class="o">.</span><span class="nf">dup</span>
  <span class="nb">self</span>
<span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-23'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-23">&#182;</a>
        </div>
        <p>Yep. This is a hack, too. Sinatra only automatically runs itself when the
file is directly called &mdash; but that&rsquo;s not the case when running through
rubygem&rsquo;s wrapped command. Solution? Just pretend we were executed directly.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="vg">$0</span> <span class="o">=</span> <span class="bp">__FILE__</span></pre></div>
      </td>
    </tr>
    <tr id='section-24'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-24">&#182;</a>
        </div>
        <p>And now we can load sinatra, knowing that the options will be parsed out of
<code>ARGV</code> and the server will start automatically.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="nb">require</span> <span class="s2">&quot;sinatra&quot;</span></pre></div>
      </td>
    </tr>
    <tr id='section-25'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-25">&#182;</a>
        </div>
        <p>I love Pathname. This line works just like you&rsquo;d expect it to:</p>

<pre><code>Pathname("/data/foo") + "." # =&gt; /data/foo
Pathname("/data/foo") + "../" # =&gt; /data
Pathname("/data/foo") + "/data" # =&gt; /data
</code></pre>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="nb">require</span> <span class="s2">&quot;pathname&quot;</span>

<span class="n">template_dir</span> <span class="o">=</span> <span class="no">Pathname</span><span class="p">(</span><span class="no">Dir</span><span class="o">.</span><span class="n">pwd</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="no">ARGV</span><span class="o">.</span><span class="n">shift</span> <span class="o">||</span> <span class="s2">&quot;.&quot;</span><span class="p">)</span>

<span class="n">set</span> <span class="ss">:public_folder</span><span class="p">,</span> <span class="n">template_dir</span>
<span class="n">set</span> <span class="ss">:views</span><span class="p">,</span> <span class="n">template_dir</span></pre></div>
      </td>
    </tr>
    <tr id='section-26'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-26">&#182;</a>
        </div>
        <p>If a favicon wasn&rsquo;t already matched by the public handler, just return a 404.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="n">get</span> <span class="s2">&quot;/favicon.ico&quot;</span> <span class="k">do</span>
  <span class="mi">404</span>
<span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-27'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-27">&#182;</a>
        </div>
        <p>This will be a container module for user-defined helpers. <code>Helpers.reload!</code>
will clean up any existing methods in the module, and then load helpers
defined in a <code>helpers.rb</code> file if it exists.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="k">module</span> <span class="nn">Helpers</span>
  <span class="k">class</span> <span class="o">&lt;&lt;</span> <span class="nb">self</span>
    <span class="k">def</span> <span class="nf">reload!</span></pre></div>
      </td>
    </tr>
    <tr id='section-28'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-28">&#182;</a>
        </div>
        <p>First we remove all instance methods in the helper module.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="nb">instance_methods</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="nb">method</span><span class="o">|</span>
        <span class="n">remove_method</span><span class="p">(</span><span class="nb">method</span><span class="p">)</span>
      <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-29'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-29">&#182;</a>
        </div>
        <p>And now we load any helper methods into the module from the file
<code>helpers.rb</code> if it exists.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="nb">module_eval</span><span class="p">(</span><span class="no">File</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s2">&quot;helpers.rb&quot;</span><span class="p">))</span> <span class="k">if</span> <span class="no">File</span><span class="o">.</span><span class="n">file?</span><span class="p">(</span><span class="s2">&quot;helpers.rb&quot;</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-30'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-30">&#182;</a>
        </div>
        <p>Include our module into the Sinatra application.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="n">helpers</span> <span class="no">Helpers</span></pre></div>
      </td>
    </tr>
    <tr id='section-31'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-31">&#182;</a>
        </div>
        <p>This is our basic handler for all requests that come through to Sinatra.
We&rsquo;ll extract the necessary path information, and then render either a haml
or sass file.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="n">handler</span> <span class="o">=</span> <span class="nb">lambda</span> <span class="k">do</span></pre></div>
      </td>
    </tr>
    <tr id='section-32'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-32">&#182;</a>
        </div>
        <p>Reload our helpers for each request.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="no">Helpers</span><span class="o">.</span><span class="n">reload!</span>

  <span class="n">path</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">path_info</span>

  <span class="n">extension</span> <span class="o">=</span> <span class="no">File</span><span class="o">.</span><span class="n">extname</span><span class="p">(</span><span class="n">path</span><span class="p">)</span></pre></div>
      </td>
    </tr>
    <tr id='section-33'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-33">&#182;</a>
        </div>
        <p>This is the most straight-forward way to remove the extension from a while
while preserving it&rsquo;s original path information.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">path</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">chomp</span><span class="p">(</span><span class="n">extension</span><span class="p">)</span></pre></div>
      </td>
    </tr>
    <tr id='section-34'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-34">&#182;</a>
        </div>
        <p>If the path is empty, it&rsquo;s a request for the index page.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">path</span> <span class="o">=</span> <span class="ss">:index</span> <span class="k">if</span> <span class="n">path</span> <span class="o">==</span> <span class="s2">&quot;/&quot;</span></pre></div>
      </td>
    </tr>
    <tr id='section-35'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-35">&#182;</a>
        </div>
        <p>We&rsquo;re rendering templates, so we need to convert to a symbol for Sinatra &mdash;
otherwise it will think we&rsquo;re rending a string.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">path</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">to_sym</span>

  <span class="k">case</span> <span class="n">extension</span>
  <span class="k">when</span> <span class="s2">&quot;.css&quot;</span></pre></div>
      </td>
    </tr>
    <tr id='section-36'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-36">&#182;</a>
        </div>
        <p>If a request for, say, &lsquo;/stylesheets/screen.css&rsquo; wasn&rsquo;t matched by the
public handler, then we try to render a sass template with the same name.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="n">sass</span> <span class="n">path</span>
  <span class="k">else</span></pre></div>
      </td>
    </tr>
    <tr id='section-37'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-37">&#182;</a>
        </div>
        <p>Otherwise, we fall back to always rendering haml.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="n">haml</span> <span class="n">path</span>
  <span class="k">end</span>
<span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-38'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-38">&#182;</a>
        </div>
        <p>Now we bind our handler to all of the <code>HTTP</code> verbs. Matching against <code>//</code> is
shorthand for matching all request paths: since <code>//</code> always returns true when
matched against a string, our handler will run on every request. We could
also write <code>get %r{/(.*)}, &amp;handler</code>.. but that just looks ugly!</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="n">get</span><span class="sr">    //, &amp;handler</span>
<span class="sr">put    /</span><span class="o">/</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">handler</span>
<span class="n">post</span><span class="sr">   //, &amp;handler</span>
<span class="sr">delete /</span><span class="o">/</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">handler</span></pre></div>
      </td>
    </tr>
    <tr id='section-39'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-39">&#182;</a>
        </div>
        <p>And that&rsquo;s it! We let Sinatra handle the rest: it will parse out any provided
options (see <code>haml-server -h</code>) and then run the server for us.</p>

      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
  </table>
</div>
</body>
